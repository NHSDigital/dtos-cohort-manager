# Durable Demographic function

Like all durable functions this function is made up of three parts in this case this function has a HTTP trigger in the form of the `DurableDemographicFunction_HttpStart` function. This function is the starting point for adding batches of records to the database. 

We take in a JSON array from process caas file. In this function we do no checking of any of the records because this would introduce overhead. Check of each record has already been done in the process caas file class. It is worth noting that if there is a problem with a batch of records then It is likely that there is a problem before this function is called. The database will also prevent duplicate records from being as there are unique constraints on the demographic table in SQL. 

as you can see all we do in this first function is: 

1. take in some json list of values
2. read the entire list in using a StreamReader 
3. then we schedule a new orchestration instance
4. then the function returns a CreateCheckStatusResponse object, this will briefly open an endpoint that allows us to check if the instance of the provided id has finished processing the current batch. If it has then we carry on send that batch the service bus in process caas file

## RunOrchestrator

In the run Orchestrator function we first check that the list from the process caas file class is not empty we do this so we that we do not waste time trying to process an empty list of records. This tries to minimize overhead 

We create `TaskOptions` object. In here is where we handle automatic retries for this function note that these options are used an argument when we await on or activity. Note we do not assign the `CallActivityAsync` method call to any variable this is important because if we do the retry options will fail to work. The second thing to note as that we do not wrap the activity function in its own try catch as this would also undermine the retry options in the `TaskOptions`. You will see instead if the `AddRange` function fails that we throw an `InvalidOperationException` this will trigger a retry. Note that if this retry function does fail it will fail an entire batch, so we do not have to worry about duplicate records being generated by this function.

## InsertDemographicData 

This function is the simplest out of all the functions in the collection of functions in this function we finally deserialize the list of records sent from process caas file. This is done by using our data services via the method AddRange. As mentioned, we will throw an error if the batch has not been added to the database. 

## GetOrchestrationStatus 

This last function is not part of the usual path that records take and is not used very much. the GetOrchestrationStatus function is called to get the status of a orchestration on the scenario the endpoint opened by the `DurableDemographicFunction_HttpStart` has been closed as the life span of that endpoint has been exceeded. This can happen even though it is very rare in that case this function is called and will go to the blob storage container where the status of a given orchestration likely still exists. 

As you can see from the code we get sent in a orchestration ID and use the method `GetInstanceAsync`. Then return the runtime status. From testing I discovered that if the runtime status for the given id does exist then it more than likely means that orchestration finished and was removed because it did not fail.

further reading:

https://learn.microsoft.com/en-us/dotnet/api/microsoft.durabletask.client.durabletaskclient.scheduleneworchestrationinstanceasync?view=durabletask-dotnet-1.x

https://learn.microsoft.com/en-us/azure/azure-functions/durable/durable-functions-error-handling?tabs=csharp-inproc

https://learn.microsoft.com/en-us/dotnet/api/microsoft.azure.webjobs.extensions.durabletask.idurableorchestrationclient.createcheckstatusresponse?view=azure-dotnet