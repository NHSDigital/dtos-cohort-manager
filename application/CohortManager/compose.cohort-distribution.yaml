name: cohort-manager

services:
  add-cohort-distribution-data:
    container_name: add-cohort-distribution-data
    image: cohort-manager-add-cohort-distribution-data
    networks: [cohman-network]
    build:
      context: ./src/Functions/
      dockerfile: CohortDistributionServices/AddCohortDistributionData/Dockerfile
    environment:
      - ASPNETCORE_URLS=http://*:7077
      - DtOsDatabaseConnectionString=Server=db,1433;Database=${DB_NAME};User Id=SA;Password=${PASSWORD};TrustServerCertificate=True
      - ExceptionFunctionURL=http://create-exception:7070/api/CreateException
      - CohortDistributionDataServiceURL=http://cohort-distribution-data-service:7992/api/CohortDistributionDataService/

  retrieve-cohort-distribution-data:
    container_name: retrieve-cohort-distribution-data
    image: cohort-manager-retrieve-cohort-distribution-data
    networks: [cohman-network]
    build:
      context: ./src/Functions/
      dockerfile: CohortDistributionServices/RetrieveCohortDistribution/Dockerfile
    profiles: [bs-select]
    environment:
      - ASPNETCORE_URLS=http://*:7078
      - DtOsDatabaseConnectionString=Server=db,1433;Database=${DB_NAME};User Id=SA;Password=${PASSWORD};TrustServerCertificate=True
      - ExceptionFunctionURL=http://create-exception:7070/api/CreateException
      - CohortDistributionDataServiceURL=http://cohort-distribution-data-service:7992/api/CohortDistributionDataService/
      - BsSelectRequestAuditDataService=http://bs-select-request-audit-data-service:7956/api/BsSelectRequestAuditDataService/
      - AcceptableLatencyThresholdMs=500
      - CohortDistributionDataServiceURL=http://localhost:7992/api/CohortDistributionDataService/

  retrieve-cohort-request-audit:
    container_name: retrieve-cohort-request-audit
    image: cohort-manager-retrieve-cohort-request-audit
    networks: [cohman-network]
    build:
      context: ./src/Functions/
      dockerfile: CohortDistributionServices/RetrieveCohortRequestAudit/Dockerfile
    profiles: [bs-select]
    environment:
      - ASPNETCORE_URLS=http://*:7086
      - DtOsDatabaseConnectionString=Server=db,1433;Database=${DB_NAME};User Id=SA;Password=${PASSWORD};TrustServerCertificate=True
      - CohortDistributionDataServiceURL=http://cohort-distribution-data-service:7992/api/CohortDistributionDataService/
      - BsSelectRequestAuditDataService=http://bs-select-request-audit-data-service:7956/api/BsSelectRequestAuditDataService/
      - ExceptionFunctionURL=http://create-exception:7070/api/CreateException

  transform-data-service:
    container_name: transform-data-service
    image: cohort-manager-transform-data-service
    networks: [cohman-network]
    build:
      context: ./src/Functions/
      dockerfile: CohortDistributionServices/TransformDataService/Dockerfile
    environment:
      - ASPNETCORE_URLS=http://*:7080
      - ExceptionFunctionURL=http://create-exception:7070/api/CreateException
      - BsSelectOutCodeUrl=http://bs-select-outcode-data-service:7881/api/BsSelectOutCodeDataService
      - BsSelectGpPracticeUrl=http://bs-select-gp-practice-data-service:7998/api/BsSelectGpPracticeDataService/
      - CohortDistributionDataServiceUrl=http://cohort-distribution-data-service:7992/api/CohortDistributionDataService/
      - DtOsDatabaseConnectionString=Server=db,1433;Database=${DB_NAME};User Id=SA;Password=${PASSWORD};TrustServerCertificate=True
      - AcceptableLatencyThresholdMs=500

  allocate-service-provider:
    container_name: allocate-service-provider
    image: cohort-manager-allocate-service-provider
    networks: [cohman-network]
    build:
      context: ./src/Functions/
      dockerfile: CohortDistributionServices/ServiceProviderAllocationService/Dockerfile
    environment:
      - ASPNETCORE_URLS=http://*:7081
      - ExceptionFunctionURL=http://create-exception:7070/api/CreateException

  create-cohort-distribution:
    container_name: create-cohort-distribution
    image: cohort-manager-create-cohort-distribution
    networks: [cohman-network]
    build:
      context: ./src/Functions/
      dockerfile: CohortDistributionServices/CreateCohortDistribution/Dockerfile
    environment:
      - ASPNETCORE_URLS=http://*:7082
      - AzureWebJobsStorage=${AZURITE_CONNECTION_STRING}
      - ExceptionFunctionURL=http://create-exception:7070/api/CreateException
      - AllocateScreeningProviderURL=http://allocate-service-provider:7081/api/AllocateServiceProviderToParticipantByService
      - TransformDataServiceURL=http://transform-data-service:7080/api/TransformDataService
      - RetrieveParticipantDataURL=http://retrieve-participant-data:7083/api/RetrieveParticipantData
      - AddCohortDistributionURL=http://add-cohort-distribution-data:7077/api/AddCohortDistributionData
      - ParticipantManagementUrl=http://participant-management-data-service:7994/api/ParticipantManagementDataService
      - ValidateCohortDistributionRecordURL=http://validate-cohort-distribution-record:7084/api/ValidateCohortDistributionRecord
      - DtOsDatabaseConnectionString=Server=db,1433;Database=${DB_NAME};User Id=SA;Password=${PASSWORD};TrustServerCertificate=True
      - CohortQueueName=cohort-distribution-queue
      - CohortQueueNamePoison=cohort-distribution-queue-poison
      - IgnoreParticipantExceptions=false
      - IsExtractedToBSSelect=true
      - AcceptableLatencyThresholdMs=500

  retrieve-participant-data:
    container_name: retrieve-participant-data
    image: cohort-manager-retrieve-participant-data
    networks: [cohman-network]
    build:
      context: ./src/Functions/
      dockerfile: CohortDistributionServices/RetrieveParticipantData/Dockerfile
    environment:
      - ASPNETCORE_URLS=http://*:7083
      - ExceptionFunctionURL=http://create-exception:7070/api/CreateException
      - ParticipantManagementUrl=http://participant-management-data-service:7994/api/ParticipantManagementDataService
      - DemographicDataFunctionURL=http://demographic-data-management:7076/api/DemographicDataFunction
      - AcceptableLatencyThresholdMs=500

  validate-cohort-distribution-record:
    container_name: validate-cohort-distribution-record
    image: cohort-manager-validate-cohort-distribution-record
    networks: [cohman-network]
    build:
      context: ./src/Functions/
      dockerfile: CohortDistributionServices/ValidateCohortDistributionRecord/Dockerfile
    environment:
      - ASPNETCORE_URLS=http://*:7084
      - LookupValidationURL=http://lookup-validation:7075/api/LookupValidation
      - ExceptionFunctionURL=http://create-exception:7070/api/CreateException
      - DtOsDatabaseConnectionString=Server=db,1433;Database=${DB_NAME};User Id=SA;Password=${PASSWORD};TrustServerCertificate=True
      - CohortDistributionDataServiceURL=http://cohort-distribution-data-service:7992/api/CohortDistributionDataService/
      - AcceptableLatencyThresholdMs=500

  remove-validation-exception-data:
    container_name: remove-validation-exception-data
    image: cohort-manager-remove-validation-exception-data
    networks: [cohman-network]
    build:
      context: ./src/Functions/
      dockerfile: ScreeningValidationService/RemoveValidationException/Dockerfile
    environment:
      - ASPNETCORE_URLS=http://*:7085
      - ExceptionFunctionURL=http://create-exception:7070/api/CreateException
      - ExceptionManagementDataServiceURL=http://exception-management-data-service:7911/api/ExceptionManagementDataService
      - DemographicDataServiceURL=http://participant-demographic-data-service:7993/api/ParticipantDemographicDataService/
      - GPPracticeDataServiceURL=http://gppractice-data-service:7999/api/GPPracticeDataService/
      - DtOsDatabaseConnectionString=Server=db,1433;Database=${DB_NAME};User Id=SA;Password=${PASSWORD};TrustServerCertificate=True

  delete-participant:
    container_name: delete-participant
    image: cohort-manager-delete-participant
    networks: [cohman-network]
    ports:
    - "7087:7087"
    build:
      context: ./src/Functions/
      dockerfile: CohortDistributionServices/DeleteParticipant/Dockerfile
    environment:
      - ASPNETCORE_URLS=http://*:7087
      - AzureWebJobsStorage=${AZURITE_CONNECTION_STRING}
      - ExceptionFunctionURL=http://create-exception:7070/api/CreateException
      - CohortDistributionDataServiceURL=http://cohort-distribution-data-service:7992/api/CohortDistributionDataService/
      - AcceptableLatencyThresholdMs=500

  #Service Now Integration
  servicenow-message:
    container_name: servicenow-message
    image: cohort-manager-servicenow-message
    networks: [cohman-network]
    labels:
    - "com.nhs.role=non-essential"
    build:
      context: ./src/Functions/
      dockerfile: ServiceNowIntegrationService/SendServiceNowMessage/Dockerfile
    profiles: [not-implemented]
    environment:
      - ASPNETCORE_URLS=http://*:9092
      - ExceptionFunctionURL=http://create-exception:7070/api/CreateException
      - ParticipantDemographicDataServiceURL=http://participant-demographic-data-service:7993/api/ParticipantDemographicDataService




networks:
  cohman-network:
    external: true
