---

parameters:
  - name: serviceConnection
    type: string

steps:
  - task: UseDotNet@2
    displayName: 'Use .NET Core sdk and install if required'
    inputs:
      packageType: 'sdk'
      version: '9.0.x'
      installationPath: $(Agent.ToolsDirectory)/dotnet

  - task: NuGetToolInstaller@1
    displayName: 'Install NuGet'

  - task: NuGetCommand@2
    displayName: 'Restore NuGet Packages'
    inputs:
      command: 'restore'
      restoreSolution: '$(Build.SourcesDirectory)/tests/smoke-tests/dtos-cohort-manager-smoke-tests.sln'
      feedsToUse: 'select'

  - task: DotNetCoreCLI@2
    displayName: 'Build smoke tests'
    inputs:
        command: 'build'
        projects: '$(Build.SourcesDirectory)/tests/smoke-tests/dtos-cohort-manager-smoke-tests.sln'
        arguments: '--configuration Release'
    
  - task: FileTransform@1
    displayName: 'Replace Connection Strings in appsettings.json'
    inputs:
      folderPath: '$(Build.SourcesDirectory)'
      jsonTargetFiles: '**/dtos-cohort-manager-smoke-tests/Config/appsettings.json'

  - task: DotNetCoreCLI@2
    displayName: 'Run SpecFlow Tests'
    inputs:
      command: 'test'
      projects: '$$(Build.SourcesDirectory)/tests/smoke-tests/dtos-cohort-manager-smoke-tests/dtos-cohort-manager-smoke-tests.csproj'
      arguments: '--filter Category=PostDeployment --logger trx --results-directory $(Build.ArtifactStagingDirectory)/TestResults'
      
