---

parameters:
  - name: serviceConnection
    type: string
  - name: resourceGroupName
    type: string

steps:
  - task: AzureCLI@2
    name: apply_database_changes
    displayName: Apply database changes
    inputs:
      azureSubscription: ${{ parameters.serviceConnection }}
      addSpnToEnvironment: true
      failOnStandardError: false
      scriptType: bash
      scriptLocation: inlineScript
      inlineScript: |
        az account set -s $(TF_VAR_TARGET_SUBSCRIPTION_ID)

        managedIdentity=$(az identity show --name mi-cohort-manager-db-management --resource-group ${{ parameters.resourceGroupName }})
        managedIdentityId=$(echo $managedIdentity | jq -r '.principalId')

        az container create \
        --resource-group ${{ parameters.resourceGroupName }} \
        --name "$(destEnvironmentShortName)-uks-db-management" \
        --image "db-management:$(selectImageTag)" \
        --registry-login-server $(sourceRegistry) \
        --registry-username dtos-cohort-manager-acr-push \
        --assign-identity $managedIdentityId \
        --restart-policy Never \
        --environment-variables \
          "connectionstring=$(DTOS_DATABASE_CONNECTION_STRING)"
